<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JGUXD Asset Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Chart.js Datalabels Plugin CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Style for the main container */
        .calculator-container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff; /* White background for the card */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 2.5rem; /* Increased padding */
            box-sizing: border-box;
        }
        /* Styles for input fields and selects */
        input[type="text"], input[type="number"], select {
            border: 1px solid #cbd5e0; /* Light gray border */
            border-radius: 0.5rem; /* Rounded input corners */
            padding: 0.75rem 1rem; /* Comfortable padding */
            transition: all 0.2s ease-in-out;
            outline: none;
            height: 3.25rem;
            width: 100%; /* Ensure inputs fill their grid space properly */
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* Soft blue glow on focus */
        }
        /* Styles for buttons */
        button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border-radius: 0.75rem; /* Rounded buttons */
            padding: 0.75rem 1.5rem;
            font-weight: 600; /* Semi-bold text */
        }
        button:hover {
            transform: translateY(-1px); /* Slight lift on hover */
        }
        button:active {
            transform: translateY(0); /* Press effect */
        }
        .add-button {
            background-color: #22c55e; /* Green for add */
            color: white;
        }
        .add-button:hover {
            background-color: #16a34a; /* Darker green on hover */
        }
        .save-button { /* New style for save button */
            background-color: #f97316; /* Orange for save */
            color: white;
        }
        .save-button:hover {
            background-color: #ea580c; /* Darker orange on hover */
        }
        .remove-button {
            background-color: #ef4444; /* Red for remove */
            color: white;
            padding: 0.5rem 1rem; /* Smaller padding for remove button */
            font-size: 0.875rem; /* Smaller font for remove button */
        }
        .remove-button:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        /* Table specific styles */
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: #e2e8f0; /* Light gray for table headers */
            font-weight: 600;
        }
        /* Updated discrepancy colors */
        .discrepancy-positive {
            color: #16a34a; /* Green for positive difference (over-allocated) */
            font-weight: bold;
        }
        .discrepancy-negative {
            color: #dc2626; /* Red for negative difference (under-allocated) */
            font-weight: bold;
        }
        .discrepancy-zero {
            color: #000000; /* Changed to Black for zero difference */
            font-weight: bold;
        }
        /* Error/Info messages */
        .message-box {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .message-error {
            background-color: #fee2e2; /* Light red */
            color: #dc2626; /* Dark red text */
            border: 1px solid #ef4444;
        }
        .message-warning {
            background-color: #fff7ed; /* Light orange */
            color: #f97316; /* Dark orange text */
            border: 1px solid #fb923c;
        }
        .message-success {
            background-color: #dcfce7; /* Light green */
            color: #16a34a; /* Dark green text */
            border: 1px solid #22c55e;
        }
        .message-info { /* For loading/saving messages */
            background-color: #e0f2fe; /* Light blue */
            color: #2563eb; /* Dark blue text */
            border: 1px solid #3b82f6;
        }

        /* Hide spinner arrows for number input (cross-browser) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }

        /* Force uppercase for Asset Name input */
        .asset-name-input {
            text-transform: uppercase;
        }

        /* Consolidated Grid Layout for Headers and Rows */
        .asset-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.2fr;
            gap: 1rem;
            align-items: start; /* Changed from center to start */
        }
        /* Responsive layout for mobile */
        @media (max-width: 639px) {
            .asset-grid {
                grid-template-columns: 1fr; /* Stack elements on a single column */
                gap: 0.5rem;
            }
            .asset-grid > * {
                width: 100%; /* Make each element full width */
            }
            .asset-grid input,
            .asset-grid select {
                max-width: 100%; /* Allow inputs to fill their space */
            }
            .asset-grid .full-asset-name-wrapper,
            .asset-grid .full-asset-name-wrapper span,
            .asset-grid .full-asset-name-wrapper input {
                width: 100%; /* Ensure full name fields are also responsive */
            }
        }
        
        .asset-row-wrapper {
            background-color: #f9fafb; /* bg-gray-50 */
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Style for the subtle X button - changed color to black */
        .remove-button.subtle-x {
            background-color: transparent; /* No background by default */
            color: #000000; /* Changed to Black 'X' */
            border: none;
            box-shadow: none;
            font-size: 1.25rem; /* Larger 'X' */
            padding: 0.25rem;
            width: 2rem; /* Fixed width/height for a perfect circle */
            height: 2rem;
            line-height: 1; /* Center the X */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            margin-left: auto;
        }
        .remove-button.subtle-x:hover {
            background-color: rgba(0, 0, 0, 0.1); /* Light black hover */
            transform: scale(1.1); /* Slightly enlarge on hover */
        }
        .remove-button.subtle-x:active {
            transform: translateY(0); /* Press effect */
        }

        /* Adjust font size for Asset Type dropdown and Save button */
        select.asset-type-dropdown {
            font-size: 0.875rem; /* text-sm equivalent, slightly smaller than default text-lg */
            height: 3.25rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        button.save-button {
            font-size: 0.75rem; /* text-xs equivalent, slightly smaller */
            padding: 0.5rem 1rem; /* Adjust padding for smaller font */
        }
        /* Style for the new add asset button as an X */
        .add-asset-button-in-row {
            background-color: #dcfce7; /* Subtle light green background */
            color: #16a34a; /* Darker Green '+' */
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
            font-size: 1.75rem; /* Larger '+' */
            padding: 0.25rem;
            width: 2.25rem; /* Slightly larger width/height */
            height: 2.25rem;
            line-height: 1; /* Center the + */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Perfect circle */
            flex-shrink: 0; /* Prevent it from shrinking */
            margin-left: auto;
        }
        .add-asset-button-in-row:hover {
            background-color: #86efac; /* More vibrant green on hover */
            transform: scale(1.1); /* Slightly enlarge on hover */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* More pronounced shadow on hover */
        }
        .add-asset-button-in-row:active {
            transform: scale(0.9); /* Press effect */
        }
        /* New style for the full asset name display and input */
        .full-asset-name-text, .full-asset-name-input-field {
            font-size: 0.75rem; /* text-xs */
            color: #4b5563; /* gray-700 */
            text-align: left;
            padding-left: 0.25rem;
            min-height: 1.25rem;
            cursor: pointer;
            padding-top: 0.125rem;
            padding-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .full-asset-name-input-field {
            border: 1px solid #cbd5e0;
            border-radius: 0.25rem;
            outline: none;
        }
        .full-asset-name-input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
        }
        .color-swatch {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .load-button {
            background-color: #3b82f6;
            color: white;
        }
        .load-button:hover {
            background-color: #2563eb;
        }
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #aaa;
        }
        .close-button:hover, .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Style for the editable description field */
        .editable-description-text {
            cursor: pointer;
            text-decoration: underline dotted #9ca3af;
            text-underline-offset: 4px;
        }
        .editable-description-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- The main container now controls the overall width and centering -->
    <div class="max-w-[900px] mx-auto w-full">

        <!-- Header Section -->
        <header class="py-4">
            <div class="px-4 sm:px-6 lg:px-8 flex items-center justify-between flex-wrap">
                <!-- Logo/Site Name -->
                <div class="text-2xl sm:text-3xl font-bold text-gray-900">
                    JGUXD Asset Calculator
                </div>
                <!-- Navigation Links -->
                <nav class="mt-4 sm:mt-0">
                    <ul class="flex space-x-4 sm:space-x-6">
                        <li><a href="#" class="text-gray-900 hover:text-gray-700 transition duration-300 ease-in-out">About</a></li>
                        <li><a href="#" class="text-gray-900 hover:text-gray-700 transition duration-300 ease-in-out">Donate</a></li>
                        <li><a href="#" class="text-gray-900 hover:text-gray-700 transition duration-300 ease-in-out">Share</a></li>
                        <li class="text-gray-900">|</li>
                        <li><a href="#" class="text-gray-900 hover:text-gray-700 transition duration-300 ease-in-out">Sign-In/Out</a></li>
                        <li><a href="#" class="text-gray-900 hover:text-gray-700 transition duration-300 ease-in-out">Settings</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Horizontal line separator -->
        <hr class="border-t border-gray-300 my-0" />

        <!-- Main Content Area (for your calculator code) -->
        <main class="flex-grow py-8 px-4 sm:px-6 lg:px-8">
            <!-- Portfolio Selection Section -->
            <div class="mb-8 flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-8">
                <!-- Dropdown and Image Container -->
                <div class="flex-shrink-0 flex items-start space-x-4 w-full md:w-auto">
                    <img id="portfolioImage" src="" alt="Portfolio thumbnail" class="w-20 h-20 rounded-md shadow-md object-cover" onerror="this.src='https://placehold.co/80x80/000000/FFFFFF?text=No+Image';">
                    <div>
                        <label for="portfolioPresetSelect" class="block text-sm font-medium text-gray-700 mb-1">Asset Allocation Strategy:</label>
                        <select id="portfolioPresetSelect" class="w-full md:w-60 h-12 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base">
                            <option value="all-weather" selected>All-Weather (Ray Dalio)</option>
                            <option value="jguxd">Growth-Weather (JGUXD)</option>
                            <option value="new-portfolio">Create New Portfolio</option>
                        </select>
                    </div>
                </div>

                <!-- Portfolio Description Section -->
                <div id="portfolioDescriptionContainer" class="flex-1 w-full mt-4 md:mt-0 p-0 text-base text-gray-700">
                    <!-- Title and description text will be dynamically inserted here -->
                </div>
            </div>

            <!-- New Portfolio Name Input Section (Initially Hidden) -->
            <div id="newPortfolioInputSection" class="mb-8 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 p-4 bg-gray-100 rounded-lg shadow-sm" style="display: none;">
                <label for="newPortfolioNameInput" class="text-lg font-semibold text-gray-700 whitespace-nowrap">New Portfolio Name:</label>
                <input type="text" id="newPortfolioNameInput" placeholder="Enter a name for your portfolio" class="flex-grow w-full border-gray-300 rounded-md shadow-sm">
                <button id="saveNewPortfolioBtn" class="save-button w-full sm:w-auto">Save New Portfolio</button>
            </div>

            <div class="calculator-container">
                <!-- Total Portfolio Amount Input -->
                <div class="mb-8 p-4 bg-blue-50 rounded-lg shadow-sm flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <label for="totalPortfolioAmountInput" class="text-lg font-semibold text-gray-700">Total Portfolio Amount ($):</label>
                    <input type="text" id="totalPortfolioAmountInput" value="100,000.00" min="0" step="100"
                           class="w-full sm:w-auto text-lg text-center font-bold text-blue-800 border-blue-300">
                </div>

                <!-- User Input Section -->
                <h2 id="userAllocationTitle" class="text-2xl font-semibold text-gray-800 mb-4">Your Asset Allocations</h2>

                <!-- Column Headers for User Input using Grid -->
                <div class="hidden sm:grid asset-grid px-4 py-2 text-sm text-gray-600 uppercase font-semibold">
                    <div class="text-left">Asset Name/Symbol</div>
                    <div class="text-left">Asset Type</div>
                    <div class="text-center">Amount ($)</div>
                    <div class="text-center">Percentage (%)</div>
                    <div></div> <!-- Empty header for X column -->
                </div>

                <div id="userAssetsContainer" class="space-y-4 mb-6">
                    <!-- User-defined assets will be added here by JavaScript -->
                </div>

                <!-- New: Blank line item for adding assets -->
                <div id="newAssetRow" class="asset-row-wrapper">
                    <div class="asset-grid">
                        <div class="flex flex-col gap-1">
                            <input type="text" id="new-asset-name" placeholder="Asset Name/Symbol" value="" class="text-lg font-medium text-gray-700 asset-name-input">
                            <div class="full-asset-name-wrapper">
                                <span id="new-full-asset-name-display" class="full-asset-name-text" data-placeholder="Full Asset Name (Click to add)"></span>
                                <input type="text" id="new-full-asset-name-input" placeholder="Full Asset Name" value="" class="full-asset-name-input-field" style="display: none;">
                            </div>
                        </div>
                        <select id="new-asset-category" class="asset-type-dropdown"></select>
                        <input type="text" id="new-asset-amount" placeholder="Amount ($)" value="0.00" min="0" step="0.01" class="text-lg text-center">
                        <input type="text" id="new-asset-percentage" placeholder="Percentage (%)" value="0.00" min="0" step="0.01" class="text-lg text-center">
                        <button id="addNewAssetBtn" class="add-asset-button-in-row rounded-full">
                            +
                        </button>
                    </div>
                </div>

                <!-- New: Total User Entered Line Items Summary -->
                <div class="asset-row-wrapper bg-blue-100 font-bold text-blue-800">
                    <div class="asset-grid items-center">
                        <div class="p-2">TOTAL:</div>
                        <div></div> <!-- Placeholder for Asset Type column alignment -->
                        <div class="text-center" id="totalEnteredAmount"></div>
                        <div class="text-center" id="totalEnteredPercentage"></div>
                        <div class="flex justify-center">
                            <!-- Removed Save Portfolio button -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 mb-6 mt-6">
                    <!-- Add Asset button moved into the newAssetRow -->
                </div>

                <!-- Summary and Error Messages -->
                <div class="border-t-2 border-gray-200 pt-6 mt-6">
                    <div id="statusMessage" class="message-box message-info text-center">
                        Initializing...
                    </div>
                </div>

                <!-- Portfolio Comparison Table -->
                <h2 class="text-2xl font-semibold text-gray-800 my-6">Portfolio Comparison</h2>
                <div class="overflow-x-auto rounded-xl shadow-md">
                    <table class="min-w-full bg-white rounded-xl">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Category</th>
                                <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Recommended (%)</th>
                                <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Your Allocated (%)</th>
                                <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Difference (%)</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody">
                            <!-- Table rows will be generated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Asset Allocation Pie Chart Section -->
                <h2 class="text-2xl font-semibold text-gray-800 my-6">Asset Allocation Pie Chart</h2>
                <div class="flex justify-center items-center p-4 bg-gray-50 rounded-lg shadow-sm" style="width: 100%; min-height: 400px; margin: 0 auto;">
                    <canvas id="portfolioPieChart" class="w-full h-full"></canvas>
                </div>

                <!-- Educational Content Area -->
                <div id="educationalContent" class="mt-8">
                    <!-- JGUXD Portfolio Education -->
                    <div id="jguxd-education">
                        <div class="p-6 bg-white rounded-xl shadow-md text-gray-800">
                            <h3 class="text-xl font-semibold mt-6 mb-2">Growth-Weather Portfolio</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                The JGUXD Growth-Weather Portfolio combines Ray Dalio's proven All-Weather asset allocation framework with carefully selected individual growth stocks. This custom strategy maintains the risk-balanced approach of the original All-Weather model while replacing low-yielding bonds with high-potential growth stocks and dividend champions, delivering both aggressive growth and defensive stability across all economic environments.
                            </p>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Original Ray Dalio All Weather Asset Allocation</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                The traditional All Weather portfolio is built with the following allocation:
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">30% Stocks:</strong> (US Equity Market)</li>
                                <li><strong class="font-semibold">40% Long-term Bonds:</strong> (20+ year Treasury bonds)</li>
                                <li><strong class="font-semibold">15% Intermediate-term Bonds:</strong> (7-10 year Treasury bonds)</li>
                                <li><strong class="font-semibold">7.5% Commodities:</strong> (Broad commodities exposure)</li>
                                <li><strong class="font-semibold">7.5% Gold:</strong> (Inflation hedge)</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Key Principles:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">Risk Parity Approach:</strong> Each asset class contributes equally to portfolio risk</li>
                                <li><strong class="font-semibold">Economic Environment Diversification:</strong> Performs across different growth/inflation scenarios</li>
                                <li><strong class="font-semibold">Lower Volatility:</strong> Designed to reduce drawdowns compared to traditional stock/bond portfolios</li>
                                <li><strong class="font-semibold">All Weather:</strong> Works in rising/falling growth and rising/falling inflation environments</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Top Stocks Alternative Portfolio</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                Replacing the All Weather allocation with top-performing individual stocks while maintaining similar sector/style diversification:
                            </p>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Stock-Based All Weather Allocation:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 ml-4">
                                <li class="mb-4">
                                    <strong class="font-semibold">Stocks (30%):</strong> (replacing general stocks)
                                    <ul class="list-circle list-inside ml-4 mt-2">
                                        <li>7.5% Apple (AAPL) - Large cap tech leader</li>
                                        <li>7.5% Microsoft (MSFT) - Cloud/software dominance</li>
                                        <li><span class="text-purple-600">7.5% NVIDIA (NVDA) - AI/semiconductor leader</span></li>
                                        <li>7.5% Amazon (AMZN) - E-commerce/cloud giant</li>
                                    </ul>
                                </li>
                                <li class="mb-4">
                                    <strong class="font-semibold">Long-Term Bonds (40%):</strong> (replacing long-term bonds)
                                    <ul class="list-circle list-inside ml-4 mt-2">
                                        <li><span class="text-purple-600">10% Berkshire Hathaway (BRK.B) - Diversified value holding</span></li>
                                        <li>10% Johnson & Johnson (JNJ) - Defensive healthcare</li>
                                        <li>10% Procter & Gamble (PG) - Consumer staples</li>
                                        <li>10% Coca-Cola (KO) - Dividend aristocrat</li>
                                    </ul>
                                </li>
                                <li class="mb-4">
                                    <strong class="font-semibold">Intermediate-Term Bonds (15%):</strong> (replacing intermediate bonds)
                                    <ul class="list-circle list-inside ml-4 mt-2">
                                        <li>5% Verizon (VZ) - High dividend telecom</li>
                                        <li><span class="text-purple-600">5% AT&T (T) - Dividend-focused utility-like</span></li>
                                        <li>5% Realty Income (O) - Monthly dividend REIT</li>
                                    </ul>
                                </li>
                                <li class="mb-4">
                                    <strong class="font-semibold">Commodities (7.5%):</strong> (replacing commodities)
                                    <ul class="list-circle list-inside ml-4 mt-2">
                                        <li>3.75% ExxonMobil (XOM) - Energy/oil exposure</li>
                                        <li><span class="text-purple-600">3.75% Freeport-McMoRan (FCX) - Copper/mining</span></li>
                                    </ul>
                                </li>
                                <li class="mb-4">
                                    <strong class="font-semibold">Gold (7.5%):</strong> (replacing gold)
                                    <ul class="list-circle list-inside ml-4 mt-2">
                                        <li><span class="text-purple-600">3.75% Newmont (NEM) - Gold mining leader</span></li>
                                        <li>3.75% Barrick Gold (GOLD) - Global gold producer</li>
                                    </ul>
                                </li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Key Differences & Considerations</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Advantages of Stock Version:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">Higher Growth Potential:</strong> Individual stocks can significantly outperform bonds</li>
                                <li><strong class="font-semibold">No Interest Rate Risk:</strong> Less sensitive to rising rates than bond portfolios</li>
                                <li><strong class="font-semibold">Inflation Protection:</strong> Many stocks naturally adjust for inflation over time</li>
                                <li><strong class="font-semibold">Active Management:</strong> Can rotate between individual names as fundamentals change</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Disadvantages of Stock Version:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">Higher Volatility:</strong> Individual stocks are much more volatile than bonds</li>
                                <li><strong class="font-semibold">Concentration Risk:</strong> Single company risk vs. diversified bond exposure</li>
                                <li><strong class="font-semibold">Correlation Risk:</strong> Stocks tend to be more correlated during market stress</li>
                                <li><strong class="font-semibold">No True "Safe Haven":</strong> Lacks the stability that government bonds provide</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Risk Profile Comparison:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">Original All Weather:</strong> Lower volatility, stable income, true diversification</li>
                                <li><strong class="font-semibold">Stock Alternative:</strong> Higher volatility, higher growth potential, equity-heavy correlation</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Implementation Notes</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">For the Stock Version:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>Consider position sizing based on volatility (lower allocations to higher-volatility names)</li>
                                <li>Regular rebalancing is more critical due to stock price movements</li>
                                <li>May want to include some actual bonds (10-20%) for true diversification</li>
                                <li>Consider ETFs for some allocations to reduce single-stock risk</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">When Bond-Free Might Work:</h3>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>Very long time horizon (20+ years)</li>
                                <li>High risk tolerance</li>
                                <li>Don't need portfolio income</li>
                                <li>Young investor who can wait out crashes</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Risk Management:</h3>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>The stock version essentially becomes a diversified equity portfolio</li>
                                <li>Consider it more of a "growth weather" than "all weather" strategy</li>
                                <li>May perform poorly in deflationary environments where bonds excel</li>
                                <li>Requires more active monitoring and potential adjustments</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Outperform the All-Weather Educational Links:</h3>
                            <ul class="list-disc list-inside text-base font-normal text-blue-600 space-y-1 ml-4 mb-4">
                                <li><a href="https://www.optimizedportfolio.com/all-weather-portfolio/" target="_blank" class="hover:underline">Ray Dalio All Weather Portfolio Review, ETFs, & Leverage (2025)</a></li>
                                <li><a href="https://retirecertain.com/all-weather-portfolio-pros-and-cons/" target="_blank" class="hover:underline">All Weather Portfolio Pros and Cons | ETFs | Performance | Chart | Videos</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- All-Weather Portfolio Education -->
                    <div id="all-weather-education" style="display: none;">
                        <div class="p-6 bg-white rounded-xl shadow-md text-gray-800">
                            <h3 class="text-xl font-semibold mt-6 mb-2">All-Weather Portfolio</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                The All-Weather Portfolio by Ray Dalio is engineered to deliver consistent returns regardless of economic conditions - whether growth is rising or falling, and whether inflation is increasing or decreasing. This institutional-grade strategy uses risk-parity principles to balance assets across four economic scenarios, providing steady performance without requiring market predictions.
                            </p>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">The Exact Asset Allocation</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                Here's exactly how to split your money:
                            </p>
                            <div class="overflow-x-auto rounded-xl shadow-md">
                                <table class="min-w-full bg-gray-50 rounded-xl">
                                    <thead>
                                        <tr class="bg-gray-200">
                                            <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Investment Type</th>
                                            <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">Percentage</th>
                                            <th class="py-3 px-4 text-left text-gray-600 uppercase text-sm">What It Does</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr class="bg-white">
                                            <td class="py-3 px-4 text-gray-900">Stocks</td>
                                            <td class="py-3 px-4 text-gray-700">30%</td>
                                            <td class="py-3 px-4 text-gray-700">Makes money when economy grows</td>
                                        </tr>
                                        <tr class="bg-white">
                                            <td class="py-3 px-4 text-gray-900">Long-term Bonds</td>
                                            <td class="py-3 px-4 text-gray-700">40%</td>
                                            <td class="py-3 px-4 text-gray-700">Makes money when economy struggles</td>
                                        </tr>
                                        <tr class="bg-white">
                                            <td class="py-3 px-4 text-gray-900">Intermediate-term Bonds</td>
                                            <td class="py-3 px-4 text-gray-700">15%</td>
                                            <td class="py-3 px-4 text-gray-700">Steady income, less risky</td>
                                        </tr>
                                        <tr class="bg-white">
                                            <td class="py-3 px-4 text-gray-900">Commodities</td>
                                            <td class="py-3 px-4 text-gray-700">7.5%</td>
                                            <td class="py-3 px-4 text-gray-700">Protection against rising prices</td>
                                        </tr>
                                        <tr class="bg-white">
                                            <td class="py-3 px-4 text-gray-900">Gold</td>
                                            <td class="py-3 px-4 text-gray-700">7.5%</td>
                                            <td class="py-3 px-4 text-gray-700">Safe haven when everything else fails</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-base font-normal text-gray-700 mb-4 mt-4">
                                What you own: Every major US company + US government and corporate bonds.
                            </p>

                            <h3 class="text-xl font-semibold mt-6 mb-2">Why It Works</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                Stocks and bonds are like a seesaw:
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>When stocks go up → bonds stay steady</li>
                                <li>When stocks crash → bonds go up</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                Result: Steady growth with much less drama.
                                <br>
                                Historical performance: ~7% per year with way fewer big drops than stocks alone.
                            </p>

                            <h3 class="text-xl font-semibold mt-6 mb-2">How to Do It</h3>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li><strong class="font-semibold">Buy:</strong> 50% VTI, 50% BND at any major broker</li>
                                <li><strong class="font-semibold">Cost:</strong> Both funds charge 0.03% (almost free)</li>
                                <li><strong class="font-semibold">Rebalance:</strong> Once per year, get back to exactly 50/50</li>
                                <li><strong class="font-semibold">Automate:</strong> Set up monthly auto-investing in both funds</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Pros & Cons</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Good:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>Dead simple (just 2 funds)</li>
                                <li>Much less stressful than all stocks</li>
                                <li>Great for beginners</li>
                                <li>Low fees</li>
                                <li>Works in most market conditions</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Bad:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>Lower returns than all-stock portfolios</li>
                                <li>Bonds can lose money when interest rates rise</li>
                                <li>"Boring" (but that's kind of the point)</li>
                            </ul>

                            <h3 class="text-xl font-semibold mt-6 mb-2">Perfect For</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">You if:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>Want simple and stress-free investing</li>
                                <li>Are just starting out</li>
                                <li>Get nervous about big market swings</li>
                                <li>Value sleep over maximum returns</li>
                            </ul>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Maybe not if:</strong>
                            </p>
                            <ul class="list-disc list-inside text-base font-normal text-gray-700 space-y-1 ml-4 mb-4">
                                <li>You're young and want maximum growth</li>
                                <li>You can handle big ups and downs for bigger gains</li>
                            </ul>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">Bottom Line</h3>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Trade-off:</strong> Give up some potential gains for much more predictable results.
                            </p>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Philosophy:</strong> "I want steady growth without the drama."
                            </p>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                <strong class="font-semibold">Truth:</strong> This boring strategy beats most "exciting" approaches over 20+ years.
                            </p>
                            <p class="text-base font-normal text-gray-700 mb-4">
                                Remember: The best strategy is the one you'll actually stick with.
                            </p>
        
                            <h3 class="text-xl font-semibold mt-6 mb-2">All-Weather Educational Links:</h3>
                            <ul class="list-disc list-inside text-base font-normal text-blue-600 space-y-1 ml-4 mb-4">
                                <li><a href="https://portfolioeinstein.com/tony-robbins-and-ray-dalios-portfolio/" target="_blank" class="hover:underline">PortfolioEinstein.com: All-Weather Portfolio: Tony Robbins And Ray Dalio With ETFs</a></li>
                                <li><a href="https://www.turingtrader.com/portfolios/robbins-all-seasons/" target="_blank" class="hover:underline">TuringTrader.com: Robbins’ All-Seasons Portfolio</a></li>
                                <li><a href="https://www.tonyrobbins.com/blog/the-end-of-the-bull-market?srsltid=AfmBOopguphPEiynN1vzOBK9dQNaGUFXAEoMDL4Lmvo1XPjfEMrFypFV" target="_blank" class="hover:underline">Ray Dalio and Tony Robbins: The End of the Bull Market</a></li>
                                <li><a href="https://www.etftrends.com/fixed-income-channel/remember-all-weather-portfolio-having-killer-year/" target="_blank" class="hover:underline"> Remember the ‘All-Weather’ Portfolio?</a></li>
                                <li><a href="https://www.iwillteachyoutoberich.com/all-weather-portfolio/" target="_blank" class="hover:underline">All Weather Portfolio: Everything You Need To Know</a></li>
                                <li><a href="https://www.youtube.com/watch?v=wkZWMDBV83w" target="_blank" class="hover:underline">Ray Dalio ALL WEATHER PORTFOLIO / What you NEED To Know!</a></li>
                                <li><a href="https://www.nasdaq.com/articles/how-invest-1-according-to-tony-robbins" target="_blank" class="hover:underline">How To Invest Like the 1%, According to Tony Robbins</a></li>
                                <li><a href="https://ofdollarsanddata.com/ray-dalio-all-weather-portfolio/" target="_blank" class="hover:underline">Ray Dalio All Weather Portfolio [2024 Update]</a></li>
                                <li><a href="https://www.cnbc.com/2018/12/11/ray-dalio-this-investment-strategy-is-good-in-a-financial-crisis.html" target="_blank" class="hover:underline">Ray Dalio says this investment strategy can help you weather a financial crisis</a></li>
                                <li><a href="https://awealthofcommonsense.com/2014/11/back-testing-tony-robbins-weather-portfolio/" target="_blank" class="hover:underline">Back-Testing The Tony Robbins All-Weather Portfolio</a></li>
                                <li><a href="https://www.wealthprofessional.ca/news/industry-news/putting-tony-robbins-all-weather-portfolio-to-the-test/185634" target="_blank" class="hover:underline">Putting Tony Robbin’s “all-weather” portfolio to the test</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modal for saved portfolios removed -->

        <!-- Horizontal line separator -->
        <hr class="border-t border-gray-300 my-0" />
        
        <!-- Legal Disclaimer Section -->
        <div class="px-4 sm:px-6 lg:px-8 text-xs text-gray-600 my-8">
            <h4 class="font-bold mb-2">IMPORTANT DISCLAIMER - PLEASE READ CAREFULLY</h4>
            <p>The content on this website is for educational and informational purposes only and does not constitute financial, investment, tax, or legal advice. We are not registered financial advisors, investment advisors, or brokers, and nothing on this site should be considered a recommendation or solicitation to buy, sell, or trade any specific security, investment product, or strategy.</p>
            <p class="mt-2"><b>INVESTMENT RISKS:</b> All investments carry substantial risk of loss, including the potential loss of your entire investment. Past performance is not indicative of future results. Market conditions, economic factors, and company-specific events can cause significant volatility and losses.</p>
            <p class="mt-2"><b>LEVERAGED PRODUCTS WARNING:</b> Leveraged ETFs, options, futures, and other leveraged instruments carry extreme risk and are not suitable for most investors. Leverage can magnify both gains and losses exponentially. You could lose significantly more than your initial investment.</p>
            <p class="mt-2"><b>INDIVIDUAL STOCKS:</b> Individual stock investments carry concentrated risk, including company-specific risks, sector risks, and market volatility. Diversification does not guarantee against loss.</p>
            <p class="mt-2"><b>NO GUARANTEES:</b> No strategy, allocation, or investment approach can guarantee profits or protect against losses. All investment strategies involve risk of substantial losses.</p>
            <p class="mt-2"><b>CONSULT PROFESSIONALS:</b> Before making any investment decisions, consult with qualified financial, tax, and legal professionals who can assess your individual circumstances, risk tolerance, and investment objectives.</p>
            <p class="mt-2"><b>PERSONAL RESPONSIBILITY:</b> You are solely responsible for your investment decisions and their consequences. Never invest money you cannot afford to lose completely.</p>
            <p class="mt-2">By using this website, you acknowledge that you understand these risks and agree to hold harmless the website operators from any investment losses or decisions made based on this content.</p>
        </div>

        <!-- Horizontal line separator -->
        <hr class="border-t border-gray-300 my-0" />

        <!-- Footer Section -->
        <footer>
            <div class="px-4 sm:px-6 lg:px-8 text-center py-4 text-gray-900 text-sm">
                <p>&copy; 2025 JGUXD Asset Calculator. All rights reserved.</p>
                <div class="text-center text-xs text-gray-400 mt-2">Authenticated User ID: <span id="userIdDisplay">N/A</span></div>
            </div>
        </footer>

    </div>
    <!-- End of main container -->

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization (MANDATORY) ---
        // These global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let firebaseConfig = null;
        if (firebaseConfigRaw) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigRaw);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }
        }

        let app;
        let db;
        let auth;
        let userId; // Will store the authenticated user's ID
        let isAuthReady = false; // Flag to track Firebase auth status
        let portfoliosRef; // Firestore collection reference
        let userSavedPortfolios = {}; // Stores user-defined saved portfolios for quick access
        let isCurrentPortfolioModified = false; // Flag to track if the current preset has been modified
        let initialPortfolioAssets = []; // Stores the initial state of assets to check for modifications

        // Initialize Firebase services
        if (firebaseConfig && firebaseConfig.projectId) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            portfoliosRef = collection(db, `artifacts/${appId}/users/anonymous_user/portfolios`);
            console.log("Firebase initialized.");
        } else {
            console.error("Firebase configuration not found or invalid (missing projectId). Data persistence will not work.");
            document.getElementById('statusMessage').textContent = "Error: Firebase not configured.";
            document.getElementById('statusMessage').classList.add('message-error');
        }

        // --- AUTHENTICATION AND DATABASE SETUP ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `${userId}`;
                // Set the Firestore reference to the correct user-specific path
                portfoliosRef = collection(db, `artifacts/${appId}/users/${userId}/portfolios`);
                isAuthReady = true;
                console.log("User signed in with UID:", userId);
                // Load saved portfolios on successful sign-in
                await populateSavedPortfoliosDropdown();
            } else {
                // User is signed out, or has not yet signed in.
                userId = crypto.randomUUID(); // Fallback to anonymous ID if no auth token is provided
                document.getElementById('userIdDisplay').textContent = `${userId}`;
                console.log("No user signed in, using anonymous ID:", userId);
            }
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .then((userCredential) => {
                    console.log("Successfully signed in with custom token.", userCredential.user.uid);
                })
                .catch((error) => {
                    console.error("Custom token sign-in failed:", error);
                    // Fallback to anonymous sign-in
                    signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                });
        } else {
            signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
        }

        // --- Constants for Ray Dalio's All-Weather Portfolio and New 60/40 ---
        const RAY_DALIO_ALLOCATION = {
            'Stocks': 30,
            'Long-Term Bonds': 40,
            'Intermediate-Term Bonds': 15,
            'Gold': 7.5,
            'Commodities': 7.5
        };
        
        // --- Simplified Asset Categories ---
        const ASSET_CATEGORIES = [
            'Stocks',
            'Long-Term Bonds',
            'Intermediate-Term Bonds',
            'Gold',
            'Commodities',
            'Other (Not Categorized)'
        ];

        // Define colors for each asset type for the pie chart
        const ASSET_COLORS = {
            'Stocks': '#4CAF50',    // Green
            'Long-Term Bonds': '#2196F3', // Blue
            'Intermediate-Term Bonds': '#03A9F4', // Lighter Blue
            'Gold': '#FFD700',      // Gold
            'Commodities': '#FF9800',  // Orange
            'Other (Not Categorized)': '#9E9E9E' // Gray
        };
        
        // --- Portfolio Descriptions for the new feature ---
        const PORTFOLIO_DESCRIPTIONS = {
            'jguxd': "The JGUXD Growth-Weather Portfolio combines Ray Dalio's proven All-Weather asset allocation framework with carefully selected individual growth stocks. This custom strategy maintains the risk-balanced approach of the original All-Weather model while replacing low-yielding bonds with high-potential growth stocks and dividend champions, delivering both aggressive growth and defensive stability across all economic environments.",
            'all-weather': "The All-Weather Portfolio by Ray Dalio is engineered to deliver consistent returns regardless of economic conditions - whether growth is rising or falling, and whether inflation is increasing or decreasing. This institutional-grade strategy uses risk-parity principles to balance assets across four economic scenarios, providing steady performance without requiring market predictions.",
            'new-portfolio': "Start building your own custom portfolio from scratch."
        };

        // --- Global Variables ---
        let userAssets = []; // Stores user-entered asset data
        let assetIdCounter = 0; // Ensures unique IDs for new assets
        let portfolioPieChartInstance; // Chart.js instance
        let currentPortfolioName = 'New Portfolio'; // Tracks the name of the currently loaded portfolio

        // --- DOM Elements ---
        const totalPortfolioAmountInput = document.getElementById('totalPortfolioAmountInput');
        const userAssetsContainer = document.getElementById('userAssetsContainer');
        const newAssetNameInput = document.getElementById('new-asset-name');
        const newAssetCategorySelect = document.getElementById('new-asset-category');
        const newAssetAmountInput = document.getElementById('new-asset-amount');
        const newAssetPercentageInput = document.getElementById('new-asset-percentage');
        const newFullAssetNameDisplay = document.getElementById('new-full-asset-name-display');
        const newFullAssetNameInput = document.getElementById('new-full-asset-name-input');
        const portfolioPresetSelect = document.getElementById('portfolioPresetSelect');
        const portfolioDescriptionContainer = document.getElementById('portfolioDescriptionContainer');
        const userAllocationTitle = document.getElementById('userAllocationTitle');
        const jguxdEducationDiv = document.getElementById('jguxd-education');
        const allWeatherEducationDiv = document.getElementById('all-weather-education');
        const newPortfolioEducationDiv = document.createElement('div');
        newPortfolioEducationDiv.id = 'new-portfolio-education';
        newPortfolioEducationDiv.style.display = 'none';
        newPortfolioEducationDiv.innerHTML = `
            <div class="p-6 bg-white rounded-xl shadow-md text-gray-800">
                <h3 class="text-xl font-semibold mt-6 mb-2">Create a Custom Portfolio</h3>
                <p class="text-base font-normal text-gray-700 mb-4">
                    Use the form above to add your own assets and create a custom asset allocation. You can enter assets by name, symbol, amount, or percentage, and the calculator will will update in real-time.
                </p>
                <p class="text-base font-normal text-gray-700 mb-4">
                    This is your canvas. Design a strategy that perfectly fits your investment philosophy.
                </p>
            </div>
        `;
        document.getElementById('educationalContent').appendChild(newPortfolioEducationDiv);

        const portfolioImage = document.getElementById('portfolioImage');

        const statusMessage = document.getElementById('statusMessage'); // Replaced totalAllocationMessage for general status
        const portfolioTableBody = document.getElementById('portfolioTableBody');
        const totalEnteredAmountSpan = document.getElementById('totalEnteredAmount');
        const totalEnteredPercentageSpan = document.getElementById('totalEnteredPercentage');
        const portfolioPieChartCanvas = document.getElementById('portfolioPieChart');
        const newPortfolioInputSection = document.getElementById('newPortfolioInputSection');
        const newPortfolioNameInput = document.getElementById('newPortfolioNameInput');
        const saveNewPortfolioBtn = document.getElementById('saveNewPortfolioBtn');


        // --- Register Chart.js Datalabels Plugin ---
        // This MUST be done once globally.
        Chart.register(ChartDataLabels);

        // --- Helper Function: Format Percentage ---
        // Ensures percentages are formatted consistently
        function formatPercentage(value) {
            const cleanValue = parseFloat(String(value).replace(/%$/g, ''));
            if (isNaN(cleanValue)) {
                return "0.00%";
            }
            return `${cleanValue.toFixed(2)}%`;
        }

        // --- Helper Function: Clean and Format Currency ---
        // Cleans the input value by removing non-numeric characters (except decimal and sign)
        // Then formats it as currency with commas and two decimal places.
        function cleanAndFormatCurrency(value) {
            const cleanValue = parseFloat(String(value).replace(/[^0-9.-]+/g,"")) || 0;
            return `$${cleanValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        }

        // --- Helper Function: Get Raw Numeric Value from Formatted String ---
        // Converts a formatted currency string back to a raw number.
        function getRawNumberFromFormattedCurrency(formattedValue) {
            return parseFloat(String(formattedValue).replace(/[^0-9.-]+/g, "")) || 0;
        }

        // --- Pie Chart Functions ---
        function updatePieChart() {
            const currentAssets = [...userAssets];
            const newAssetAmount = getRawNumberFromFormattedCurrency(newAssetAmountInput.value);
            const newAssetPercentage = parseFloat(String(newAssetPercentageInput.value).replace('%', '')) || 0;

            if (newAssetHasData()) {
                currentAssets.push({
                    category: newAssetCategorySelect.value,
                    percentage: newAssetPercentage
                });
            }

            const aggregatedData = {};
            currentAssets.forEach(asset => {
                const category = ASSET_CATEGORIES.includes(asset.category) ? asset.category : 'Other (Not Categorized)';
                if (aggregatedData[category]) {
                    aggregatedData[category] += asset.percentage;
                } else {
                    aggregatedData[category] = asset.percentage;
                }
            });

            const labels = Object.keys(aggregatedData);
            const data = Object.values(aggregatedData);
            const colors = labels.map(label => ASSET_COLORS[label] || ASSET_COLORS['Other (Not Categorized)']);

            const chartLabels = [];
            const chartData = [];
            const chartColors = [];

            labels.forEach((label, index) => {
                if (data[index] > 0) {
                    chartLabels.push(label);
                    chartData.push(data[index]);
                    chartColors.push(colors[index]);
                }
            });

            if (portfolioPieChartInstance) {
                portfolioPieChartInstance.data.labels = chartLabels;
                portfolioPieChartInstance.data.datasets[0].data = chartData;
                portfolioPieChartInstance.data.datasets[0].backgroundColor = chartColors;
                portfolioPieChartInstance.update();
            } else {
                const ctx = portfolioPieChartCanvas.getContext('2d');
                portfolioPieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 40,
                                bottom: 20,
                                left: 20,
                                right: 20
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                display: true,
                                labels: {
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatPercentage(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#000000',
                                formatter: (value, context) => {
                                    if (value > 0) {
                                        return formatPercentage(value);
                                    }
                                    return '';
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 8,
                                font: {
                                    weight: 'bold'
                                },
                                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                                borderRadius: 4,
                                padding: 4,
                                connectorLine: {
                                    display: false
                                },
                                clamp: true
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        // --- Core Function: Recalculate and Display ---
        function recalculateAndDisplay() {
            // Sort assets by percentage in descending order
            userAssets.sort((a, b) => b.percentage - a.percentage);
            renderAllAssets();
            renderPortfolioTable();
            validateTotalAllocation();
            updateUserEnteredTotals();
            updatePieChart();
            checkIfModified();
        }

        // --- User Assets Section Functions ---
        
        // Renders all assets from the `userAssets` array.
        function renderAllAssets() {
            userAssetsContainer.innerHTML = ''; // Clear previous assets
            userAssets.forEach(asset => renderAssetRow(asset));
        }

        // Helper function to check if the new asset row has any meaningful data
        function newAssetHasData() {
            const newAssetAmount = getRawNumberFromFormattedCurrency(newAssetAmountInput.value);
            const newAssetPercentage = parseFloat(String(newAssetPercentageInput.value).replace('%', '')) || 0;
            const hasFullName = newFullAssetNameInput.value || (newFullAssetNameDisplay.textContent !== newFullAssetNameDisplay.dataset.placeholder && newFullAssetNameInput.style.display === 'none');
            return newAssetNameInput.value || hasFullName || newAssetCategorySelect.value !== ASSET_CATEGORIES[0] || newAssetAmount > 0 || newAssetPercentage > 0;
        }

        // Function to add a new asset to the userAssets array and render its row
        function addAssetFromNewRow() {
            const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
            
            if (newAssetHasData()) {
                const newAssetData = {
                    name: newAssetNameInput.value,
                    fullName: newFullAssetNameInput.value || newFullAssetNameDisplay.textContent,
                    category: newAssetCategorySelect.value,
                    amount: getRawNumberFromFormattedCurrency(newAssetAmountInput.value),
                    percentage: parseFloat(String(newAssetPercentageInput.value).replace('%','')) || 0
                };
                
                const newAsset = {
                    id: assetIdCounter++,
                    name: String(newAssetData.name).toUpperCase(),
                    fullName: newAssetData.fullName === newFullAssetNameDisplay.dataset.placeholder ? '' : newAssetData.fullName,
                    category: newAssetData.category,
                    amount: newAssetData.amount,
                    percentage: newAssetData.percentage
                };

                if (newAssetData.amount > 0 && newAssetData.percentage === 0) {
                    if (currentTotalPortfolioAmount > 0) {
                        newAsset.percentage = (newAsset.amount / currentTotalPortfolioAmount) * 100;
                    }
                } else if (newAssetData.percentage > 0 && newAssetData.amount === 0) {
                    if (currentTotalPortfolioAmount > 0) {
                        newAsset.amount = (newAsset.percentage / 100) * currentTotalPortfolioAmount;
                    }
                }

                userAssets.push(newAsset);
            }
            
            newAssetNameInput.value = '';
            newFullAssetNameInput.value = '';
            newFullAssetNameDisplay.textContent = newFullAssetNameDisplay.dataset.placeholder;
            newFullAssetNameDisplay.style.display = 'block';
            newFullAssetNameInput.style.display = 'none';

            newAssetCategorySelect.value = ASSET_CATEGORIES[0];
            newAssetAmountInput.value = '0.00';
            newAssetPercentageInput.value = '0.00%';

            newAssetNameInput.focus();

            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        }

        // This function is used for programmatically adding initial/default assets
        function addInitialAsset(initialData = {}) {
            const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
            const newAsset = {
                id: assetIdCounter++,
                name: initialData.name || '',
                fullName: initialData.fullName || '',
                category: initialData.category || ASSET_CATEGORIES[0],
                percentage: initialData.percentage || 0
            };
            newAsset.amount = (newAsset.percentage / 100) * currentTotalPortfolioAmount;
            userAssets.push(newAsset);
        }

        // Function to remove an asset from the userAssets array and its row from DOM
        function removeAsset(idToRemove) {
            userAssets = userAssets.filter(asset => asset.id !== idToRemove);
            document.getElementById(`user-asset-wrapper-${idToRemove}`)?.remove();
            isCurrentPortfolioModified = true;
            recalculateAndDisplay();
        }

        // Function to update an asset's properties in the data model
        function updateAssetData(idToUpdate, field, value) {
            const assetIndex = userAssets.findIndex(asset => asset.id === idToUpdate);
            if (assetIndex === -1) return;

            const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
            const asset = userAssets[assetIndex];

            if (field === 'amount') {
                asset.amount = Math.max(0, value);
                if (currentTotalPortfolioAmount > 0) {
                    asset.percentage = (asset.amount / currentTotalPortfolioAmount) * 100;
                } else {
                    asset.percentage = 0;
                }
                const percentageInput = document.getElementById(`asset-percentage-${idToUpdate}`);
                if (percentageInput) percentageInput.value = formatPercentage(asset.percentage);
            } else if (field === 'percentage') {
                asset.percentage = Math.max(0, value);
                if (currentTotalPortfolioAmount > 0) {
                    asset.amount = (asset.percentage / 100) * currentTotalPortfolioAmount;
                } else {
                    asset.amount = 0;
                }
                const amountInput = document.getElementById(`asset-amount-${idToUpdate}`);
                if (amountInput) amountInput.value = cleanAndFormatCurrency(asset.amount);
            } else if (field === 'name') {
                asset.name = String(value).toUpperCase();
            } else if (field === 'fullName') {
                asset.fullName = value;
            } else {
                asset[field] = value;
            }
            isCurrentPortfolioModified = true;
        }

        // Function to render a single asset row into the DOM
        function renderAssetRow(asset) {
            const assetWrapperDiv = document.createElement('div');
            assetWrapperDiv.className = 'asset-row-wrapper';
            assetWrapperDiv.id = `user-asset-wrapper-${asset.id}`;

            const formattedAmount = cleanAndFormatCurrency(asset.amount);
            const formattedPercentage = formatPercentage(asset.percentage);

            assetWrapperDiv.innerHTML = `
                <div class="asset-grid">
                    <div class="flex flex-col gap-1">
                        <input type="text" id="asset-name-${asset.id}" placeholder="Asset Name/Symbol" value="${asset.name}"
                                class="text-lg font-medium text-gray-700 asset-name-input">
                        <div class="full-asset-name-wrapper">
                            <span id="full-asset-name-display-${asset.id}" class="full-asset-name-text" data-placeholder="Full Asset Name (Click to add)">${asset.fullName || 'Click to add full name'}</span>
                            <input type="text" id="full-asset-name-input-${asset.id}" placeholder="Full Asset Name" value="${asset.fullName}"
                                    class="full-asset-name-input-field" style="display: none;">
                        </div>
                    </div>
                    <select id="asset-category-${asset.id}" class="asset-type-dropdown"></select>
                    <input type="text" id="asset-amount-${asset.id}" placeholder="Amount ($)" value="${formattedAmount}" min="0" step="0.01"
                            class="text-lg text-center">
                    <input type="text" id="asset-percentage-${asset.id}" placeholder="Percentage (%)" value="${formattedPercentage}" min="0" step="0.01"
                            class="text-lg text-center">
                    <button id="remove-asset-${asset.id}" class="remove-button subtle-x rounded-full">
                        X
                    </button>
                </div>
            `;

            const categorySelect = assetWrapperDiv.querySelector(`#asset-category-${asset.id}`);
            ASSET_CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            categorySelect.value = asset.category;

            assetWrapperDiv.querySelector(`#asset-name-${asset.id}`).addEventListener('input', (e) => updateAssetData(asset.id, 'name', e.target.value));
            assetWrapperDiv.querySelector(`#asset-name-${asset.id}`).addEventListener('blur', recalculateAndDisplay);
            
            const fullAssetNameDisplay = assetWrapperDiv.querySelector(`#full-asset-name-display-${asset.id}`);
            const fullAssetNameInput = assetWrapperDiv.querySelector(`#full-asset-name-input-${asset.id}`);

            fullAssetNameDisplay.addEventListener('click', () => {
                fullAssetNameDisplay.style.display = 'none';
                fullAssetNameInput.style.display = 'block';
                fullAssetNameInput.value = fullAssetNameDisplay.textContent === fullAssetNameDisplay.dataset.placeholder ? '' : fullAssetNameDisplay.textContent;
                fullAssetNameInput.focus();
            });

            fullAssetNameInput.addEventListener('blur', (e) => {
                const newValue = e.target.value;
                updateAssetData(asset.id, 'fullName', newValue);
                fullAssetNameDisplay.textContent = newValue || fullAssetNameDisplay.dataset.placeholder;
                fullAssetNameDisplay.style.display = 'block';
                fullAssetNameInput.style.display = 'none';
                recalculateAndDisplay();
            });

            fullAssetNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            });

            assetWrapperDiv.querySelector(`#asset-category-${asset.id}`).addEventListener('change', (e) => {
                updateAssetData(asset.id, 'category', e.target.value);
                recalculateAndDisplay();
            });
            
            const amountInput = assetWrapperDiv.querySelector(`#asset-amount-${asset.id}`);
            amountInput.addEventListener('input', (e) => {
                const rawValue = getRawNumberFromFormattedCurrency(e.target.value);
                const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
                let calculatedPercentage = 0;
                if (currentTotalPortfolioAmount > 0) {
                    calculatedPercentage = (rawValue / currentTotalPortfolioAmount) * 100;
                }
                document.getElementById(`asset-percentage-${asset.id}`).value = calculatedPercentage.toFixed(2);
                updateUserEnteredTotals();
                isCurrentPortfolioModified = true;
            });
            amountInput.addEventListener('blur', (e) => {
                e.target.value = cleanAndFormatCurrency(e.target.value);
                recalculateAndDisplay();
            });
            amountInput.value = cleanAndFormatCurrency(asset.amount);

            const percentageInput = assetWrapperDiv.querySelector(`#asset-percentage-${asset.id}`);
            percentageInput.addEventListener('input', (e) => {
                const rawValue = parseFloat(String(e.target.value).replace('%','')) || 0;
                const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
                let calculatedAmount = 0;
                if (currentTotalPortfolioAmount > 0) {
                    calculatedAmount = (rawValue / 100) * currentTotalPortfolioAmount;
                }
                document.getElementById(`asset-amount-${asset.id}`).value = calculatedAmount.toFixed(2);
                updateUserEnteredTotals();
                isCurrentPortfolioModified = true;
            });
            percentageInput.addEventListener('blur', (e) => {
                e.target.value = formatPercentage(e.target.value);
                recalculateAndDisplay();
            });
            percentageInput.value = formatPercentage(asset.percentage);

            assetWrapperDiv.querySelector(`#remove-asset-${asset.id}`).addEventListener('click', () => removeAsset(asset.id));

            userAssetsContainer.appendChild(assetWrapperDiv);
        }

        // --- Function to update the user-entered totals line ---
        function updateUserEnteredTotals() {
            const assetsForCalculation = [...userAssets];
            const newAssetAmount = getRawNumberFromFormattedCurrency(newAssetAmountInput.value);
            const newAssetPercentage = parseFloat(String(newAssetPercentageInput.value).replace('%', '')) || 0;

            if (newAssetHasData()) {
                assetsForCalculation.push({
                    amount: newAssetAmount,
                    percentage: newAssetPercentage
                });
            }

            const totalAmountSum = assetsForCalculation.reduce((sum, asset) => sum + (parseFloat(asset.amount) || 0), 0);
            const totalPercentageSum = assetsForCalculation.reduce((sum, asset) => sum + (parseFloat(asset.percentage) || 0), 0);

            totalEnteredAmountSpan.textContent = cleanAndFormatCurrency(totalAmountSum);
            totalEnteredPercentageSpan.textContent = formatPercentage(totalPercentageSum);
        }

        // --- Total Allocation Validation Functions ---

        // Function to get the current total user allocation percentage (including blank row)
        function getTotalUserAllocationPercentageWithNewRow() {
            const assetsForCalculation = [...userAssets];
            const newAssetAmount = getRawNumberFromFormattedCurrency(newAssetAmountInput.value);
            const newAssetPercentage = parseFloat(String(newAssetPercentageInput.value).replace('%', '')) || 0;

            if (newAssetHasData()) {
                assetsForCalculation.push({
                    amount: newAssetAmount,
                    percentage: newAssetPercentage
                });
            }
            return assetsForCalculation.reduce((sum, asset) => sum + (parseFloat(asset.percentage) || 0), 0);
        }

        // Function to validate the total user allocation (percentage) and display messages
        function validateTotalAllocation() {
            const totalPercentage = getTotalUserAllocationPercentageWithNewRow();
            statusMessage.className = 'message-box text-center';

            if (userAssets.length === 0 && !newAssetHasData()) {
                statusMessage.textContent = `Please add assets to start your portfolio calculation.`;
                statusMessage.classList.add('message-warning');
            } else if (totalPercentage > 100.01 || totalPercentage < 99.99) {
                const difference = (totalPercentage - 100).toFixed(2);
                if (difference > 0) {
                    statusMessage.textContent = `Total allocation is ${formatPercentage(totalPercentage)}. You are +${difference}% Over 100%. Adjust your allocations.`;
                    statusMessage.classList.add('message-error');
                } else {
                    statusMessage.textContent = `Total allocation is ${formatPercentage(totalPercentage)}. You are ${difference}% Under 100%. Adjust your allocations.`;
                    statusMessage.classList.add('message-warning');
                }
            } else {
                statusMessage.textContent = `Total allocation is ${formatPercentage(totalPercentage)}. Exactly 100%! Well done.`;
                statusMessage.classList.add('message-success');
            }
        }

        // --- Portfolio Comparison Table Functions ---

        // Function to render the comparison table
        function renderPortfolioTable() {
            portfolioTableBody.innerHTML = '';
            
            const assetsForCalculation = [...userAssets];
            const newAssetAmount = getRawNumberFromFormattedCurrency(newAssetAmountInput.value);
            const newAssetPercentage = parseFloat(String(newAssetPercentageInput.value).replace('%', '')) || 0;

            if (newAssetHasData()) {
                assetsForCalculation.push({
                    name: newAssetNameInput.value,
                    category: newAssetCategorySelect.value,
                    amount: newAssetAmount,
                    percentage: newAssetPercentage
                });
            }

            const allCategories = [...new Set([...ASSET_CATEGORIES, ...Object.keys(RAY_DALIO_ALLOCATION), ...assetsForCalculation.map(asset => asset.category)])];

            const userCategoryAllocations = allCategories.reduce((acc, category) => {
                acc[category] = 0;
                return acc;
            }, {});

            assetsForCalculation.forEach(asset => {
                const category = ASSET_CATEGORIES.includes(asset.category) ? asset.category : 'Other (Not Categorized)';
                userCategoryAllocations[category] += (parseFloat(asset.percentage) || 0);
            });
            
            // Loop through all possible categories to build the table
            allCategories.forEach(category => {
                // Skip 'Other' unless it has a value
                if (category === 'Other (Not Categorized)' && userCategoryAllocations[category] <= 0) {
                    return;
                }

                const recommended = RAY_DALIO_ALLOCATION[category] || 0;
                const userAllocated = userCategoryAllocations[category] || 0;
                const difference = userAllocated - recommended;

                const row = portfolioTableBody.insertRow();
                row.className = 'border-b border-gray-200 last:border-b-0';

                const categoryCell = row.insertCell();
                const swatch = document.createElement('span');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = ASSET_COLORS[category] || ASSET_COLORS['Other (Not Categorized)'];
                categoryCell.appendChild(swatch);
                categoryCell.appendChild(document.createTextNode(category));
                categoryCell.className = 'text-gray-900 flex items-center';

                const recommendedCell = row.insertCell();
                recommendedCell.textContent = (category in RAY_DALIO_ALLOCATION) ? formatPercentage(recommended) : '-';
                recommendedCell.className = 'text-gray-700';

                const userAllocatedCell = row.insertCell();
                userAllocatedCell.textContent = formatPercentage(userAllocated);
                userAllocatedCell.className = 'text-gray-900 font-semibold';

                const differenceCell = row.insertCell();
                if (category in RAY_DALIO_ALLOCATION) {
                    differenceCell.textContent = formatPercentage(difference);
                    if (Math.abs(difference) > 0.01) {
                        if (difference > 0) {
                            differenceCell.classList.remove('discrepancy-negative', 'discrepancy-zero');
                            differenceCell.classList.add('discrepancy-positive');
                        } else {
                            differenceCell.classList.remove('discrepancy-positive', 'discrepancy-zero');
                            differenceCell.classList.add('discrepancy-negative');
                        }
                    } else {
                        differenceCell.classList.remove('discrepancy-positive', 'discrepancy-negative');
                        differenceCell.classList.add('discrepancy-zero');
                    }
                } else {
                    differenceCell.textContent = '-';
                }
            });
        }
        
        // --- Portfolio Preset Data ---
        // Defines the data for the three portfolio presets.
        const PORTFOLIO_PRESETS = {
            'jguxd': {
                name: 'Growth-Weather (JGUXD)',
                key: 'jguxd',
                image: 'https://placehold.co/80x80/000000/FFFFFF?text=JGUXD',
                assets: [
                    { name: 'NVDA', fullName: 'NVIDIA', category: 'Stocks', percentage: 30 },
                    { name: 'BRK.B', fullName: 'Berkshire Hathaway', category: 'Long-Term Bonds', percentage: 40 },
                    { name: 'T', fullName: 'AT&T', category: 'Intermediate-Term Bonds', percentage: 15 },
                    { name: 'FCX', fullName: 'Freeport-McMoRan', category: 'Commodities', percentage: 7.5 },
                    { name: 'NEM', fullName: 'Newmont', category: 'Gold', percentage: 7.5 }
                ]
            },
            'all-weather': {
                name: 'All-Weather (Ray Dalio)',
                key: 'all-weather',
                image: 'https://placehold.co/80x80/000000/FFFFFF?text=All-%0AWeather',
                assets: [
                    { name: 'VTI', fullName: 'Vanguard Total Stock Market Index Fund ETF', category: 'Stocks', percentage: 30 },
                    { name: 'TLT', fullName: 'iShares 20+ Year Treasury Bond ETF', category: 'Long-Term Bonds', percentage: 40 },
                    { name: 'IEF', fullName: 'iShares 7-10 Year Treasury Bond ETF', category: 'Intermediate-Term Bonds', percentage: 15 },
                    { name: 'GLD', fullName: 'SPDR Gold Shares', category: 'Gold', percentage: 7.5 },
                    { name: 'DBC', fullName: 'Invesco DB Commodity Index Tracking Fund', category: 'Commodities', percentage: 7.5 }
                ]
            },
            'new-portfolio': {
                name: 'New Portfolio',
                key: 'new-portfolio',
                image: 'https://placehold.co/80x80/E0F2FE/2563EB?text=NEW',
                assets: []
            }
        };
        

        // --- Event Listeners for the NEW BLANK ASSET ROW INPUTS ---
        newAssetNameInput.addEventListener('input', (e) => {
            newAssetNameInput.value = String(e.target.value).toUpperCase();
            updateUserEnteredTotals();
        });
        newAssetNameInput.addEventListener('blur', () => {
            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        });

        newFullAssetNameDisplay.addEventListener('click', () => {
            newFullAssetNameDisplay.style.display = 'none';
            newFullAssetNameInput.style.display = 'block';
            newFullAssetNameInput.value = newFullAssetNameDisplay.textContent === newFullAssetNameDisplay.dataset.placeholder ? '' : newFullAssetNameDisplay.textContent;
            newFullAssetNameInput.focus();
        });

        newFullAssetNameInput.addEventListener('blur', (e) => {
            const newValue = e.target.value;
            updateAssetData(-1, 'fullName', newValue);
            newFullAssetNameDisplay.textContent = newValue || newFullAssetNameDisplay.dataset.placeholder;
            newFullAssetNameDisplay.style.display = 'block';
            newFullAssetNameInput.style.display = 'none';
            recalculateAndDisplay();
        });
        newFullAssetNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.target.blur();
            }
        });

        newAssetCategorySelect.addEventListener('change', () => {
            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        });

        newAssetAmountInput.addEventListener('input', (e) => {
            const rawValue = getRawNumberFromFormattedCurrency(e.target.value);
            const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
            let calculatedPercentage = 0;
            if (currentTotalPortfolioAmount > 0) {
                calculatedPercentage = (rawValue / currentTotalPortfolioAmount) * 100;
            }
            newAssetPercentageInput.value = calculatedPercentage.toFixed(2);
            updateUserEnteredTotals();
        });
        newAssetAmountInput.addEventListener('blur', (e) => {
            e.target.value = cleanAndFormatCurrency(e.target.value);
            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        });

        newAssetPercentageInput.addEventListener('input', (e) => {
            const rawValue = parseFloat(String(e.target.value).replace('%','')) || 0;
            const currentTotalPortfolioAmount = getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value);
            let calculatedAmount = 0;
            if (currentTotalPortfolioAmount > 0) {
                calculatedAmount = (rawValue / 100) * currentTotalPortfolioAmount;
            }
            newAssetAmountInput.value = calculatedAmount.toFixed(2);
            updateUserEnteredTotals();
        });
        newAssetPercentageInput.addEventListener('blur', (e) => {
            e.target.value = formatPercentage(e.target.value);
            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        });


        // Event listener for total portfolio amount input
        totalPortfolioAmountInput.addEventListener('input', (e) => {
            let newTotalAmount = getRawNumberFromFormattedCurrency(e.target.value);
            if (newTotalAmount < 0) {
                newTotalAmount = 0;
            }
            
            userAssets.forEach(asset => {
                const currentPercentage = parseFloat(asset.percentage) || 0;
                asset.amount = (currentPercentage / 100) * newTotalAmount;
                const amountInput = document.getElementById(`asset-amount-${asset.id}`);
                if (amountInput && document.activeElement !== amountInput) {
                    amountInput.value = cleanAndFormatCurrency(asset.amount);
                }
            });
            updateUserEnteredTotals();
        });

        // Add blur event listener to totalPortfolioAmountInput for final formatting and update
        totalPortfolioAmountInput.addEventListener('blur', (e) => {
            const rawValue = getRawNumberFromFormattedCurrency(e.target.value);
            e.target.value = cleanAndFormatCurrency(rawValue);
            recalculateAndDisplay();
            isCurrentPortfolioModified = true;
        });

        // Event listener for the new add asset button in the blank row
        addNewAssetBtn.addEventListener('click', addAssetFromNewRow);

        // New event listener for saving a new portfolio from the dedicated input field
        saveNewPortfolioBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                statusMessage.textContent = "Authentication is not ready. Please wait a moment.";
                statusMessage.className = 'message-box message-warning text-center';
                return;
            }
            const portfolioName = newPortfolioNameInput.value.trim();
            if (!portfolioName) {
                statusMessage.textContent = "Save failed. Please enter a name for your new portfolio.";
                statusMessage.className = 'message-box message-error text-center';
                return;
            }
            
            statusMessage.textContent = `Saving new portfolio "${portfolioName}"...`;
            statusMessage.className = 'message-box message-info text-center';

            try {
                // Ensure all data is up-to-date before saving
                recalculateAndDisplay();
                
                // Get the current portfolio state
                const currentPortfolio = {
                    name: portfolioName,
                    totalAmount: getRawNumberFromFormattedCurrency(totalPortfolioAmountInput.value),
                    assets: userAssets,
                    description: (document.getElementById('portfolio-description-input-field') || document.getElementById('portfolio-description-text'))?.value || (document.getElementById('portfolio-description-input-field') || document.getElementById('portfolio-description-text'))?.textContent || '',
                    timestamp: new Date().toISOString()
                };

                // Save to Firestore
                await setDoc(doc(portfoliosRef, portfolioName), currentPortfolio);

                statusMessage.textContent = `Portfolio "${portfolioName}" saved successfully!`;
                statusMessage.className = 'message-box message-success text-center';

                // Update the dropdown with the new portfolio and select it
                await populateSavedPortfoliosDropdown(portfolioName);

                // Reset the new portfolio input fields and state
                newPortfolioNameInput.value = '';
                newPortfolioInputSection.style.display = 'none';
                isCurrentPortfolioModified = false;
                initialPortfolioAssets = [];

            } catch (error) {
                console.error("Error saving new portfolio:", error);
                statusMessage.textContent = "Error saving new portfolio. See console for details.";
                statusMessage.className = 'message-box message-error text-center';
            }
        });

        function checkIfModified() {
            const presetKey = portfolioPresetSelect.value;
            if (isCurrentPortfolioModified && ['all-weather', 'jguxd'].includes(presetKey)) {
                newPortfolioInputSection.style.display = 'flex';
                newPortfolioNameInput.placeholder = `Save a copy of ${PORTFOLIO_PRESETS[presetKey].name}`;
            } else if (presetKey !== 'new-portfolio') {
                newPortfolioInputSection.style.display = 'none';
            }
        }


        function loadPortfolioData(portfolio) {
            // Clear existing assets and UI
            userAssets = [];
            userAssetsContainer.innerHTML = '';
            assetIdCounter = 0; // Reset ID counter
            
            // Set the total portfolio amount from the loaded data
            totalPortfolioAmountInput.value = cleanAndFormatCurrency(portfolio.totalAmount);
            currentPortfolioName = portfolio.name;

            // Load assets from the saved portfolio
            portfolio.assets.forEach(assetData => {
                addInitialAsset(assetData);
            });
            
            recalculateAndDisplay();
            updatePortfolioDescriptionArea(`saved-${portfolio.name}`);
            updateUserAllocationTitle(portfolio.name);
            portfolioImage.src = 'https://placehold.co/80x80/2563EB/E0F2FE?text=Saved';
            newPortfolioEducationDiv.style.display = 'block';
            statusMessage.textContent = `Portfolio "${portfolio.name}" loaded successfully!`;
            statusMessage.className = 'message-box message-success text-center';
            
            // Set modified state to false on load
            isCurrentPortfolioModified = false;
        }

        // --- Portfolio Preset Data and Listeners ---

        // Function to update the portfolio description and title
        function updatePortfolioDescriptionArea(presetKey) {
            const preset = PORTFOLIO_PRESETS[presetKey] || userSavedPortfolios[presetKey];
            if (!preset) return;

            const presetName = preset.name;
            const existingDescription = preset.description || 'This is a custom portfolio you have created. Click here to add a custom description.';
            const isCustom = presetKey.startsWith('saved-') || presetKey === 'new-portfolio';
            
            let descriptionHtml;
            if (isCustom) {
                descriptionHtml = `
                    <div class="p-0 text-base text-gray-700">
                        <h4 class="font-bold text-lg mb-2">${presetName}</h4>
                        <span id="portfolio-description-text" class="editable-description-text">${existingDescription}</span>
                        <input type="text" id="portfolio-description-input-field" class="editable-description-input" value="${existingDescription}" style="display:none;">
                    </div>
                `;
            } else {
                const description = PORTFOLIO_DESCRIPTIONS[presetKey];
                descriptionHtml = `
                    <h4 class="font-bold text-lg mb-2">${presetName}</h4>
                    <p class="text-base text-gray-700">${description}</p>
                `;
            }
            portfolioDescriptionContainer.innerHTML = descriptionHtml;

            if (isCustom) {
                const descriptionText = document.getElementById('portfolio-description-text');
                const descriptionInput = document.getElementById('portfolio-description-input-field');

                descriptionText.addEventListener('click', () => {
                    descriptionText.style.display = 'none';
                    descriptionInput.style.display = 'block';
                    descriptionInput.focus();
                });

                descriptionInput.addEventListener('blur', (e) => saveDescription(e.target.value));
                descriptionInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveDescription(e.target.value);
                    }
                });
            }
        }

        async function saveDescription(newDescription) {
            const descriptionText = document.getElementById('portfolio-description-text');
            const descriptionInput = document.getElementById('portfolio-description-input-field');
            if (descriptionText && descriptionInput) {
                const trimmedDescription = newDescription.trim() || 'This is a custom portfolio you have created. Click here to add a custom description.';
                descriptionText.textContent = trimmedDescription;
                descriptionText.style.display = 'block';
                descriptionInput.style.display = 'none';
                
                if (isAuthReady) {
                    try {
                        const savedPortfolio = userSavedPortfolios[`saved-${currentPortfolioName}`];
                        if (savedPortfolio) {
                             await setDoc(doc(portfoliosRef, currentPortfolioName), {
                                 ...savedPortfolio,
                                 description: trimmedDescription
                             });
                             console.log(`Description for "${currentPortfolioName}" updated successfully.`);
                             userSavedPortfolios[`saved-${currentPortfolioName}`].description = trimmedDescription; // Update local cache
                        }
                    } catch (error) {
                        console.error("Error saving new description:", error);
                    }
                }
            }
        }

        // Function to update the user allocation title
        function updateUserAllocationTitle(portfolioName) {
            userAllocationTitle.textContent = `${portfolioName} Asset Allocation`;
        }

        // Function to fetch and populate saved portfolios in the dropdown
        async function populateSavedPortfoliosDropdown(selectName = null) {
            if (!isAuthReady || !db) {
                console.warn("Firebase not ready. Cannot populate dropdown.");
                return;
            }

            // Clear previous saved options
            const currentOptions = Array.from(portfolioPresetSelect.options).filter(o => o.value.startsWith('saved-'));
            currentOptions.forEach(o => o.remove());
            userSavedPortfolios = {};
            
            try {
                const q = query(portfoliosRef);
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const portfolio = doc.data();
                    const valueKey = `saved-${portfolio.name}`;
                    const option = new Option(`${portfolio.name} (Saved)`, valueKey);
                    portfolioPresetSelect.appendChild(option);
                    userSavedPortfolios[valueKey] = portfolio;
                });
                if (selectName) {
                    portfolioPresetSelect.value = `saved-${selectName}`;
                    const event = new Event('change');
                    portfolioPresetSelect.dispatchEvent(event);
                }
            } catch (error) {
                console.error("Error populating saved portfolios:", error);
            }
        }
        
        // Event listener for the new portfolio preset dropdown
        portfolioPresetSelect.addEventListener('change', (e) => {
            const presetKey = e.target.value;
            const presetData = PORTFOLIO_PRESETS[presetKey];

            // Hide all educational content divs
            jguxdEducationDiv.style.display = 'none';
            allWeatherEducationDiv.style.display = 'none';
            newPortfolioEducationDiv.style.display = 'none';
            
            // Show/hide the new portfolio input section
            if (presetKey === 'new-portfolio') {
                newPortfolioInputSection.style.display = 'flex';
                // Clear the asset list to create a blank canvas
                userAssets = [];
                userAssetsContainer.innerHTML = '';
            } else {
                newPortfolioInputSection.style.display = 'none';
            }
            
            // Update image source and load data
            if (presetKey.startsWith('saved-')) {
                const savedPortfolio = userSavedPortfolios[presetKey];
                loadPortfolioData(savedPortfolio);
            } else if (presetData) {
                // Clear existing assets and UI for all presets
                userAssets = [];
                userAssetsContainer.innerHTML = '';
                
                // Load assets from the selected preset, unless it's the "new-portfolio" preset
                assetIdCounter = 0; // Reset ID counter
                if (presetKey !== 'new-portfolio') {
                    presetData.assets.forEach(assetData => {
                        addInitialAsset(assetData);
                    });
                }
                
                // Update the UI
                recalculateAndDisplay();
                statusMessage.textContent = `Portfolio preset "${e.target.options[e.target.selectedIndex].text}" loaded successfully!`;
                statusMessage.classList.remove('message-info', 'message-error', 'message-warning');
                statusMessage.classList.add('message-success');
                // Update image for built-in presets
                portfolioImage.src = presetData.image;

                // Show the relevant educational content
                if (presetKey === 'jguxd') {
                    jguxdEducationDiv.style.display = 'block';
                } else if (presetKey === 'all-weather') {
                    allWeatherEducationDiv.style.display = 'block';
                } else if (presetKey === 'new-portfolio') {
                    newPortfolioEducationDiv.style.display = 'block';
                }
            }

            updatePortfolioDescriptionArea(presetKey);
            updateUserAllocationTitle(presetKey.startsWith('saved-') ? userSavedPortfolios[presetKey].name : presetData.name);
            isCurrentPortfolioModified = false;
        });

        // Initial setup on page load
        window.onload = () => {
            // Populate the category dropdown for the blank new asset row
            ASSET_CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                newAssetCategorySelect.appendChild(option);
            });
            newAssetCategorySelect.value = ASSET_CATEGORIES[0];
            newFullAssetNameDisplay.textContent = newFullAssetNameDisplay.dataset.placeholder;
            
            // Set initial total portfolio amount
            const initialTotal = 100000;
            totalPortfolioAmountInput.value = cleanAndFormatCurrency(initialTotal);

            // Set the default preset to 'all-weather'
            const defaultPresetKey = 'all-weather';
            const defaultPreset = PORTFOLIO_PRESETS[defaultPresetKey];
            
            if (defaultPreset) {
                defaultPreset.assets.forEach(assetData => {
                    addInitialAsset(assetData);
                });
                // Set the initial dropdown value and image
                portfolioPresetSelect.value = defaultPresetKey;
                portfolioImage.src = defaultPreset.image;
            }

            // Set initial portfolio description and title
            updatePortfolioDescriptionArea(defaultPresetKey);
            updateUserAllocationTitle(defaultPreset.name);

            // Initial display of table and messages for defaults
            recalculateAndDisplay();
            
            // Set initial status message
            statusMessage.textContent = "Welcome to the JGUXD Asset Investment Calculator!";
            statusMessage.classList.remove('message-info', 'message-error');
            statusMessage.classList.add('message-success');

            // Show default educational content
            allWeatherEducationDiv.style.display = 'block';
        };
    </script>
</body>
</html>
